{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Files Extension\n *\n * Tracks files read/written/edited by the agent in the current session.\n * Use /files (or optional shortcut) to select a file and open it in your editor.\n * Files are sorted by most recent access, with operation indicators (R/W/E).\n *\n * Settings (configurable via /extension-settings):\n * - editorCommand: Command to open files (space-separated, e.g., \"code -g\")\n * - shortcut: Keyboard shortcut to open file list (e.g., \"ctrl+f\")\n */\n\nimport * as path from \"node:path\";\nimport { getSetting, type SettingDefinition } from \"@juanibiapina/pi-extension-settings\";\nimport type { ExtensionAPI, ExtensionContext } from \"@mariozechner/pi-coding-agent\";\nimport { DynamicBorder } from \"@mariozechner/pi-coding-agent\";\nimport { Container, Key, type KeyId, matchesKey, type SelectItem, SelectList, Text } from \"@mariozechner/pi-tui\";\n\ntype FileOperation = \"read\" | \"write\" | \"edit\";\n\ninterface FileEntry {\n\tpath: string;\n\toperations: Set<FileOperation>;\n\tlastTimestamp: number;\n}\n\nfunction toRelativePath(filePath: string, cwd: string): string {\n\tif (path.isAbsolute(filePath)) {\n\t\tconst rel = path.relative(cwd, filePath);\n\t\treturn rel || filePath;\n\t}\n\treturn filePath;\n}\n\nfunction rebuildFromSession(ctx: ExtensionContext, cwd: string): Map<string, FileEntry> {\n\tconst fileMap = new Map<string, FileEntry>();\n\tconst branch = ctx.sessionManager.getBranch();\n\n\t// First pass: collect tool calls (id -> {path, name, timestamp})\n\tconst toolCalls = new Map<string, { path: string; name: FileOperation; timestamp: number }>();\n\n\tfor (const entry of branch) {\n\t\tif (entry.type !== \"message\") continue;\n\t\tconst msg = entry.message;\n\n\t\tif (msg.role === \"assistant\" && Array.isArray(msg.content)) {\n\t\t\tfor (const block of msg.content) {\n\t\t\t\tif (block.type === \"toolCall\") {\n\t\t\t\t\tconst name = block.name as string;\n\t\t\t\t\tif (name === \"read\" || name === \"write\" || name === \"edit\") {\n\t\t\t\t\t\tconst toolPath = (block.arguments as Record<string, unknown>)?.path;\n\t\t\t\t\t\tif (toolPath && typeof toolPath === \"string\") {\n\t\t\t\t\t\t\ttoolCalls.set(block.id, {\n\t\t\t\t\t\t\t\tpath: toRelativePath(toolPath, cwd),\n\t\t\t\t\t\t\t\tname: name as FileOperation,\n\t\t\t\t\t\t\t\ttimestamp: msg.timestamp,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Second pass: match tool results to get actual execution timestamp\n\tfor (const entry of branch) {\n\t\tif (entry.type !== \"message\") continue;\n\t\tconst msg = entry.message;\n\n\t\tif (msg.role === \"toolResult\") {\n\t\t\tconst toolCall = toolCalls.get(msg.toolCallId);\n\t\t\tif (!toolCall) continue;\n\n\t\t\tconst { path: filePath, name } = toolCall;\n\t\t\tconst timestamp = msg.timestamp;\n\n\t\t\tconst existing = fileMap.get(filePath);\n\t\t\tif (existing) {\n\t\t\t\texisting.operations.add(name);\n\t\t\t\tif (timestamp > existing.lastTimestamp) {\n\t\t\t\t\texisting.lastTimestamp = timestamp;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfileMap.set(filePath, {\n\t\t\t\t\tpath: filePath,\n\t\t\t\t\toperations: new Set([name]),\n\t\t\t\t\tlastTimestamp: timestamp,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\treturn fileMap;\n}\n\nexport default function (pi: ExtensionAPI) {\n\t// Register settings via event (for /extension-settings UI)\n\tpi.events.emit(\"pi-extension-settings:register\", {\n\t\tname: \"files\",\n\t\tsettings: [\n\t\t\t{\n\t\t\t\tid: \"editorCommand\",\n\t\t\t\tlabel: \"Editor command\",\n\t\t\t\tdescription: \"Command to open files (space-separated, path is appended). Example: code -g\",\n\t\t\t\tdefaultValue: \"\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"shortcut\",\n\t\t\t\tlabel: \"Keyboard shortcut\",\n\t\t\t\tdescription: \"Shortcut to open file list. Example: ctrl+f\",\n\t\t\t\tdefaultValue: \"\",\n\t\t\t},\n\t\t] satisfies SettingDefinition[],\n\t});\n\tlet fileMap = new Map<string, FileEntry>();\n\tlet cwd = \"\";\n\n\t// Handler for showing file list\n\tconst showFileList = async (ctx: ExtensionContext) => {\n\t\tif (!ctx.hasUI) {\n\t\t\tctx.ui.notify(\"No UI available\", \"error\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (fileMap.size === 0) {\n\t\t\tctx.ui.notify(\"No files mentioned yet\", \"info\");\n\t\t\treturn;\n\t\t}\n\n\t\t// Sort by most recent first\n\t\tconst files = Array.from(fileMap.values()).sort((a, b) => b.lastTimestamp - a.lastTimestamp);\n\n\t\tconst openSelected = async (file: FileEntry): Promise<void> => {\n\t\t\tconst editorCommand = getSetting(\"files\", \"editorCommand\");\n\t\t\tif (!editorCommand) {\n\t\t\t\tctx.ui.notify(\"editorCommand not configured\", \"error\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst parts = editorCommand.split(/\\s+/).filter(Boolean);\n\t\t\tif (parts.length === 0) {\n\t\t\t\tctx.ui.notify(\"editorCommand not configured\", \"error\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst [cmd, ...args] = parts;\n\t\t\tconst result = await pi.exec(cmd, [...args, file.path]);\n\t\t\tctx.ui.notify(\n\t\t\t\tresult.code === 0 ? `Opened ${file.path}` : `Error: ${result.stderr}`,\n\t\t\t\tresult.code === 0 ? \"info\" : \"error\",\n\t\t\t);\n\t\t};\n\n\t\t// Show file picker with SelectList\n\t\tawait ctx.ui.custom<void>((tui, theme, _kb, done) => {\n\t\t\tconst container = new Container();\n\n\t\t\t// Top border\n\t\t\tcontainer.addChild(new DynamicBorder((s: string) => theme.fg(\"accent\", s)));\n\n\t\t\t// Title\n\t\t\tcontainer.addChild(new Text(theme.fg(\"accent\", theme.bold(\" Select file to open\")), 0, 0));\n\n\t\t\t// Build select items with colored operations\n\t\t\tconst items: SelectItem[] = files.map((f) => {\n\t\t\t\tconst ops: string[] = [];\n\t\t\t\tif (f.operations.has(\"read\")) ops.push(theme.fg(\"muted\", \"R\"));\n\t\t\t\tif (f.operations.has(\"write\")) ops.push(theme.fg(\"success\", \"W\"));\n\t\t\t\tif (f.operations.has(\"edit\")) ops.push(theme.fg(\"warning\", \"E\"));\n\t\t\t\tconst opsLabel = ops.join(\"\");\n\t\t\t\treturn {\n\t\t\t\t\tvalue: f.path,\n\t\t\t\t\tlabel: `${opsLabel} ${f.path}`,\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tconst visibleRows = Math.min(files.length, 15);\n\t\t\tlet currentIndex = 0;\n\n\t\t\tconst selectList = new SelectList(items, visibleRows, {\n\t\t\t\tselectedPrefix: (t) => theme.fg(\"accent\", t),\n\t\t\t\tselectedText: (t) => t,\n\t\t\t\tdescription: (t) => theme.fg(\"muted\", t),\n\t\t\t\tscrollInfo: (t) => theme.fg(\"dim\", t),\n\t\t\t\tnoMatch: (t) => theme.fg(\"warning\", t),\n\t\t\t});\n\t\t\tselectList.onSelect = (item) => {\n\t\t\t\tdone();\n\t\t\t\tconst entry = fileMap.get(item.value);\n\t\t\t\tif (entry) void openSelected(entry);\n\t\t\t};\n\t\t\tselectList.onCancel = () => done();\n\t\t\tselectList.onSelectionChange = (item) => {\n\t\t\t\tcurrentIndex = items.indexOf(item);\n\t\t\t};\n\t\t\tcontainer.addChild(selectList);\n\n\t\t\t// Help text\n\t\t\tcontainer.addChild(new Text(theme.fg(\"dim\", \" ↑↓ navigate • ←→ page • enter open • esc close\"), 0, 0));\n\n\t\t\t// Bottom border\n\t\t\tcontainer.addChild(new DynamicBorder((s: string) => theme.fg(\"accent\", s)));\n\n\t\t\treturn {\n\t\t\t\trender: (w) => container.render(w),\n\t\t\t\tinvalidate: () => container.invalidate(),\n\t\t\t\thandleInput: (data) => {\n\t\t\t\t\tif (matchesKey(data, Key.left)) {\n\t\t\t\t\t\tcurrentIndex = Math.max(0, currentIndex - visibleRows);\n\t\t\t\t\t\tselectList.setSelectedIndex(currentIndex);\n\t\t\t\t\t} else if (matchesKey(data, Key.right)) {\n\t\t\t\t\t\tcurrentIndex = Math.min(items.length - 1, currentIndex + visibleRows);\n\t\t\t\t\t\tselectList.setSelectedIndex(currentIndex);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tselectList.handleInput(data);\n\t\t\t\t\t}\n\t\t\t\t\ttui.requestRender();\n\t\t\t\t},\n\t\t\t};\n\t\t});\n\t};\n\n\t// Command to show and select from mentioned files\n\tpi.registerCommand(\"files\", {\n\t\tdescription: \"Show and select from mentioned files\",\n\t\thandler: async (_args, ctx) => showFileList(ctx),\n\t});\n\n\t// Shortcut to show file list (if configured)\n\tconst shortcut = getSetting(\"files\", \"shortcut\");\n\tif (shortcut) {\n\t\tpi.registerShortcut(shortcut as KeyId, {\n\t\t\tdescription: \"Show and select from mentioned files\",\n\t\t\thandler: async (ctx) => showFileList(ctx),\n\t\t});\n\t}\n\n\t// Collect paths from file tool calls\n\tpi.on(\"tool_call\", async (event, ctx) => {\n\t\tif (!ctx.hasUI) return;\n\n\t\tconst name = event.toolName;\n\t\tif (name === \"read\" || name === \"write\" || name === \"edit\") {\n\t\t\tconst input = event.input as { path?: string };\n\t\t\tif (input?.path) {\n\t\t\t\tconst filePath = toRelativePath(input.path, cwd);\n\t\t\t\tconst existing = fileMap.get(filePath);\n\t\t\t\tconst timestamp = Date.now();\n\n\t\t\t\tif (existing) {\n\t\t\t\t\texisting.operations.add(name as FileOperation);\n\t\t\t\t\texisting.lastTimestamp = timestamp;\n\t\t\t\t} else {\n\t\t\t\t\tfileMap.set(filePath, {\n\t\t\t\t\t\tpath: filePath,\n\t\t\t\t\t\toperations: new Set([name as FileOperation]),\n\t\t\t\t\t\tlastTimestamp: timestamp,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n\n\t// Clear on session switch\n\tpi.on(\"session_switch\", async (_event, _ctx) => {\n\t\tfileMap.clear();\n\t});\n\n\t// Rebuild from session on start (handles resume)\n\tpi.on(\"session_start\", async (_event, ctx) => {\n\t\tcwd = ctx.cwd;\n\t\tfileMap = rebuildFromSession(ctx, cwd);\n\t});\n}\n"]}